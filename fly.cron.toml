# fly.cron.toml - Configuration for the production news ingestion cron machine
#
# This defines a scheduled machine that runs the news ingestion hourly.
# It shares the same Docker image as the main app but runs a different command.
#
# NOTE: Fly.io scheduled machines only support: hourly, daily, weekly, monthly
#       (not custom cron expressions like "*/30 * * * *")
#
# Deployment:
#   1. First, deploy the main app to build the image:
#      flyctl deploy --config fly.prod.toml --app draft-app-prod
#
#   2. Create the scheduled machine (one-time setup):
#      IMAGE=$(flyctl machine list --app draft-app-prod --json | grep '"image":' | head -1 | sed 's/.*"image": "\([^"]*\)".*/\1/')
#      flyctl machine run $IMAGE \
#        --app draft-app-prod \
#        --schedule hourly \
#        --name news-ingestion-cron \
#        --region ewr \
#        --memory 512 \
#        --cpus 1 \
#        --entrypoint "/app/.venv/bin/python" \
#        -- -m app.cli.cron_runner
#
#   3. To update the machine after code changes (handled by GitHub Actions):
#      flyctl machine update <machine-id> --app draft-app-prod --yes
#
# Monitoring:
#   - View logs: flyctl logs --app draft-app-prod --instance <machine-id>
#   - List machines: flyctl machine list --app draft-app-prod
#   - Check status: flyctl machine status <machine-id> --app draft-app-prod

app = 'draft-app-prod'
primary_region = 'ewr'

[build]

# Override the default command to run the cron script
[processes]
  cron = "/app/.venv/bin/python -m app.cli.cron_runner"

[[vm]]
  memory = '512mb'
  cpu_kind = 'shared'
  cpus = 1
