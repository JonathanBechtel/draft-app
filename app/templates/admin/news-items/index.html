{% extends "admin/base.html" %}

{% set page_title = "News Items" %}
{% set active_nav = "news-items" %}

{% block admin_content %}
<header class="admin-main__header">
  <h1 class="admin-main__title">News Items</h1>
  <p class="admin-main__subtitle">Manage news items from RSS feeds</p>
</header>

<div class="admin-card">
  <div class="admin-card__header">
    <h2 class="admin-card__title">All Items ({{ total }})</h2>
  </div>

  <!-- Filters -->
  <form class="admin-filters" method="get" action="/admin/news-items">
    <input type="hidden" name="limit" value="{{ limit }}">

    <div class="admin-filters__row">
      <div class="admin-filters__field">
        <label class="admin-filters__label" for="source_id">Source</label>
        <select class="admin-form__select" id="source_id" name="source_id">
          <option value="">All Sources</option>
          {% for src in all_sources %}
          <option value="{{ src.id }}" {% if source_id == src.id %}selected{% endif %}>
            {{ src.display_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="admin-filters__field">
        <label class="admin-filters__label" for="tag">Tag</label>
        <select class="admin-form__select" id="tag" name="tag">
          <option value="">All Tags</option>
          {% for t in tags %}
          <option value="{{ t.value }}" {% if tag == t.value %}selected{% endif %}>
            {{ t.value }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="admin-filters__field">
        <label class="admin-filters__label" for="date_from">From</label>
        <input class="admin-form__input" type="date" id="date_from" name="date_from"
               value="{{ date_from or '' }}">
      </div>

      <div class="admin-filters__field">
        <label class="admin-filters__label" for="date_to">To</label>
        <input class="admin-form__input" type="date" id="date_to" name="date_to"
               value="{{ date_to or '' }}">
      </div>

      <div class="admin-filters__actions">
        <button type="submit" class="admin-btn admin-btn--primary admin-btn--small">Filter</button>
        <a href="/admin/news-items" class="admin-btn admin-btn--secondary admin-btn--small">Reset</a>
      </div>
    </div>
  </form>

  {% if items %}
  <table class="admin-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Source</th>
        <th>Tag</th>
        <th>Published</th>
        <th>Player</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td>
          <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" class="admin-link">
            {{ item.title | truncate(60) }}
          </a>
        </td>
        <td>
          {% if sources_map.get(item.source_id) %}
          {{ sources_map[item.source_id].display_name }}
          {% else %}
          <span class="admin-text--placeholder">Unknown</span>
          {% endif %}
        </td>
        <td>
          <span class="admin-badge admin-badge--tag">{{ item.tag.value }}</span>
        </td>
        <td>{{ item.published_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
          {% if item.player_id and players_map.get(item.player_id) %}
          {{ players_map[item.player_id].display_name }}
          {% else %}
          <span class="admin-text--placeholder">â€”</span>
          {% endif %}
        </td>
        <td>
          <div class="admin-table__actions">
            <a href="/admin/news-items/{{ item.id }}" class="admin-btn admin-btn--secondary admin-btn--small">Edit</a>
            <form method="post" action="/admin/news-items/{{ item.id }}/delete" class="admin-form--inline" onsubmit="return confirm('Are you sure you want to delete this news item?');">
              <button type="submit" class="admin-btn admin-btn--danger admin-btn--small">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  {% if pages > 1 %}
  <nav class="admin-pagination">
    <div class="admin-pagination__info">
      Showing {{ offset + 1 }}-{{ [offset + limit, total] | min }} of {{ total }}
    </div>
    <div class="admin-pagination__controls">
      {% if current_page > 1 %}
      <a href="/admin/news-items?limit={{ limit }}&offset={{ (current_page - 2) * limit }}{% if source_id %}&source_id={{ source_id }}{% endif %}{% if tag %}&tag={{ tag }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
         class="admin-btn admin-btn--secondary admin-btn--small">Previous</a>
      {% endif %}

      <span class="admin-pagination__pages">
        Page {{ current_page }} of {{ pages }}
      </span>

      {% if current_page < pages %}
      <a href="/admin/news-items?limit={{ limit }}&offset={{ current_page * limit }}{% if source_id %}&source_id={{ source_id }}{% endif %}{% if tag %}&tag={{ tag }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
         class="admin-btn admin-btn--secondary admin-btn--small">Next</a>
      {% endif %}
    </div>
  </nav>
  {% endif %}

  {% else %}
  <div class="admin-empty">
    <div class="admin-empty__icon">&#128240;</div>
    <h3 class="admin-empty__title">No News Items</h3>
    <p class="admin-empty__text">
      {% if source_id or tag or date_from or date_to %}
      No items match your filters. Try adjusting the criteria.
      {% else %}
      News items will appear here after they are ingested from RSS feeds.
      {% endif %}
    </p>
    {% if source_id or tag or date_from or date_to %}
    <a href="/admin/news-items" class="admin-btn admin-btn--secondary">Clear Filters</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
