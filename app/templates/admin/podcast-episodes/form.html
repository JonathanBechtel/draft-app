{% extends "admin/base.html" %}

{% set page_title = "Edit Podcast Episode" %}
{% set active_nav = "podcast-episodes" %}

{% block admin_content %}
<header class="admin-main__header">
  <h1 class="admin-main__title">Edit Podcast Episode</h1>
  <p class="admin-main__subtitle">Modify tag, summary, or player association</p>
</header>

<div class="admin-card admin-card--medium">
  <!-- Read-only info section -->
  <div class="admin-form__section">
    <h3 class="admin-form__section-title">Episode Details</h3>

    <div class="admin-form__static-field">
      <label class="admin-form__label">Show</label>
      <p class="admin-form__static">{{ show.display_name if show else 'Unknown' }}</p>
    </div>

    <div class="admin-form__static-field">
      <label class="admin-form__label">External ID</label>
      <p class="admin-form__static">{{ episode.external_id }}</p>
    </div>

    <div class="admin-form__static-field">
      <label class="admin-form__label">Published</label>
      <p class="admin-form__static">{{ episode.published_at.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>

    {% if episode.duration_seconds %}
    <div class="admin-form__static-field">
      <label class="admin-form__label">Duration</label>
      <p class="admin-form__static">{{ (episode.duration_seconds // 60) }} minutes</p>
    </div>
    {% endif %}

    {% if episode.description %}
    <div class="admin-form__static-field">
      <label class="admin-form__label">Description</label>
      <p class="admin-form__static admin-form__static--multiline">{{ episode.description | truncate(500) }}</p>
    </div>
    {% endif %}
  </div>

  <!-- Editable form section -->
  <form class="admin-form" method="post" action="/admin/podcast-episodes/{{ episode.id }}">
    <h3 class="admin-form__section-title">Editable Fields</h3>

    <div class="admin-form__field">
      <label class="admin-form__label" for="title">Title</label>
      <input
        class="admin-form__input"
        id="title"
        name="title"
        type="text"
        value="{{ episode.title }}"
        required
      />
    </div>

    <div class="admin-form__field">
      <label class="admin-form__label" for="tag">Tag</label>
      <select class="admin-form__select" id="tag" name="tag" required>
        {% for t in tags %}
        <option value="{{ t.value }}" {% if episode.tag == t %}selected{% endif %}>
          {{ t.value }}
        </option>
        {% endfor %}
      </select>
      <span class="admin-form__help">Classification for this episode</span>
    </div>

    <div class="admin-form__field">
      <label class="admin-form__label" for="summary">Summary</label>
      <textarea
        class="admin-form__textarea"
        id="summary"
        name="summary"
        rows="3"
        placeholder="AI-generated or manual summary..."
      >{{ episode.summary or '' }}</textarea>
      <span class="admin-form__help">A concise summary for display in feeds</span>
    </div>

    <div class="admin-form__field">
      <label class="admin-form__label" for="audio_url">Audio URL</label>
      <input
        class="admin-form__input"
        id="audio_url"
        name="audio_url"
        type="url"
        value="{{ episode.audio_url }}"
        required
      />
    </div>

    <div class="admin-form__field">
      <label class="admin-form__label" for="episode_url">Episode URL</label>
      <input
        class="admin-form__input"
        id="episode_url"
        name="episode_url"
        type="url"
        value="{{ episode.episode_url or '' }}"
        placeholder="https://example.com/episode/..."
      />
      <span class="admin-form__help">Optional link to the episode page</span>
    </div>

    <div class="admin-form__field">
      <label class="admin-form__label" for="player_search">Associated Player</label>
      <input type="hidden" id="player_id" name="player_id" value="{{ episode.player_id or '' }}">
      <div class="admin-search-box">
        <input
          type="text"
          id="player_search"
          class="admin-form__input"
          value="{{ player.display_name if player else '' }}"
          placeholder="Search for a player..."
          autocomplete="off"
        >
        <div id="player_results" class="admin-search-results"></div>
      </div>
      <div class="admin-form__help-row">
        <span class="admin-form__help">Link this episode to a specific prospect</span>
        <button type="button" class="admin-btn admin-btn--link admin-btn--small" id="clear_player">Clear</button>
      </div>
    </div>

    <div class="admin-form__actions">
      <button type="submit" class="admin-btn admin-btn--primary">Save Changes</button>
      <a href="/admin/podcast-episodes" class="admin-btn admin-btn--secondary">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block admin_js %}
<script>
(function() {
  const playerSearch = document.getElementById('player_search');
  const playerIdInput = document.getElementById('player_id');
  const resultsDiv = document.getElementById('player_results');
  const clearBtn = document.getElementById('clear_player');

  let searchTimeout;

  playerSearch.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();

    if (query.length < 2) {
      resultsDiv.classList.remove('active');
      resultsDiv.innerHTML = '';
      return;
    }

    searchTimeout = setTimeout(async function() {
      try {
        const resp = await fetch('/players/search?q=' + encodeURIComponent(query));
        if (!resp.ok) {
          resultsDiv.classList.remove('active');
          return;
        }
        const results = await resp.json();
        renderResults(results);
      } catch (err) {
        console.error('Player search failed:', err);
        resultsDiv.classList.remove('active');
      }
    }, 150);
  });

  playerSearch.addEventListener('focus', function() {
    if (resultsDiv.children.length > 0) {
      resultsDiv.classList.add('active');
    }
  });

  document.addEventListener('click', function(e) {
    if (!playerSearch.contains(e.target) && !resultsDiv.contains(e.target)) {
      resultsDiv.classList.remove('active');
    }
  });

  clearBtn.addEventListener('click', function() {
    playerIdInput.value = '';
    playerSearch.value = '';
    resultsDiv.classList.remove('active');
    resultsDiv.innerHTML = '';
  });

  function renderResults(results) {
    if (!results || results.length === 0) {
      resultsDiv.innerHTML = '<div class="admin-search-result admin-search-result--empty">No players found</div>';
      resultsDiv.classList.add('active');
      return;
    }

    resultsDiv.innerHTML = results.map(function(p) {
      const schoolInfo = p.school ? ' (' + p.school + ')' : '';
      return '<div class="admin-search-result" data-id="' + p.id + '" data-name="' + escapeHtml(p.display_name) + '">' +
        escapeHtml(p.display_name) + schoolInfo +
        '</div>';
    }).join('');

    resultsDiv.querySelectorAll('.admin-search-result[data-id]').forEach(function(el) {
      el.addEventListener('click', function() {
        selectPlayer(el.dataset.id, el.dataset.name);
      });
    });

    resultsDiv.classList.add('active');
  }

  function selectPlayer(id, name) {
    playerIdInput.value = id;
    playerSearch.value = name;
    resultsDiv.classList.remove('active');
    resultsDiv.innerHTML = '';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
{% endblock %}
